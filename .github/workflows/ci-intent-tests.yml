name: Architectural Integrity Checks

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main, develop]
  schedule:
    # Nightly drift report
    - cron: '0 2 * * *'

jobs:
  selfcheck:
    name: Self-Check Guardrails
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install pyyaml
      
      - name: Run guardrail validation
        run: |
          python infra/selfcheck/validate_guardrails.py --strict
        continue-on-error: false
      
      - name: Upload guardrail results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: guardrail-results
          path: guardrail-results.json
          if-no-files-found: ignore

  lint-architecture:
    name: Lint Architecture
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Check for circular dependencies
        run: |
          python infra/selfcheck/check_circular_deps.py
      
      - name: Check main.py size
        run: |
          LINES=$(wc -l < backend/main.py)
          if [ $LINES -gt 2000 ]; then
            echo "⚠️ main.py has $LINES lines (threshold: 2000)"
            echo "Consider splitting into route modules"
            exit 1
          fi

  schema-validate:
    name: Schema Validation
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: floyo
          POSTGRES_PASSWORD: floyo
          POSTGRES_DB: floyo
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
        ports:
          - 5432:5432
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
      
      - name: Set environment variables
        run: |
          echo "DATABASE_URL=postgresql://floyo:floyo@localhost:5432/floyo" >> $GITHUB_ENV
          echo "SECRET_KEY=test-secret-key-for-ci-validation-only" >> $GITHUB_ENV
          echo "ENVIRONMENT=development" >> $GITHUB_ENV
      
      - name: Run migrations
        run: |
          alembic upgrade head
      
      - name: Check migration status
        run: |
          python infra/selfcheck/check_migration_status.py
      
      - name: Validate environment completeness
        run: |
          python infra/selfcheck/validate_env_completeness.py

  api-contract-tests:
    name: API Contract Tests
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: floyo
          POSTGRES_PASSWORD: floyo
          POSTGRES_DB: floyo
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
        ports:
          - 5432:5432
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
      
      - name: Set environment variables
        run: |
          echo "DATABASE_URL=postgresql://floyo:floyo@localhost:5432/floyo" >> $GITHUB_ENV
          echo "SECRET_KEY=test-secret-key-for-ci-validation-only" >> $GITHUB_ENV
          echo "ENVIRONMENT=development" >> $GITHUB_ENV
      
      - name: Run migrations
        run: |
          alembic upgrade head
      
      - name: Start backend server
        run: |
          uvicorn backend.main:app --host 0.0.0.0 --port 8000 &
          sleep 5
      
      - name: Test health endpoints
        run: |
          curl -f http://localhost:8000/health || exit 1
          curl -f http://localhost:8000/health/readiness || exit 1
          curl -f http://localhost:8000/health/liveness || exit 1
      
      - name: Test system selfcheck endpoint
        run: |
          curl -f http://localhost:8000/system/selfcheck || echo "⚠️ Selfcheck endpoint not yet implemented"

  architectural-integrity:
    name: Architectural Integrity Report
    runs-on: ubuntu-latest
    needs: [selfcheck, lint-architecture, schema-validate]
    if: always()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Generate integrity report
        run: |
          echo "# Architectural Integrity Report" > integrity-report.md
          echo "" >> integrity-report.md
          echo "Generated: $(date)" >> integrity-report.md
          echo "" >> integrity-report.md
          echo "## Status" >> integrity-report.md
          echo "" >> integrity-report.md
          echo "- Self-Check: ${{ needs.selfcheck.result }}" >> integrity-report.md
          echo "- Lint Architecture: ${{ needs.lint-architecture.result }}" >> integrity-report.md
          echo "- Schema Validation: ${{ needs.schema-validate.result }}" >> integrity-report.md
      
      - name: Upload integrity report
        uses: actions/upload-artifact@v4
        with:
          name: integrity-report
          path: integrity-report.md

  # Block PR if critical violations
  block-pr-on-failure:
    name: Block PR on Critical Failures
    runs-on: ubuntu-latest
    needs: [selfcheck, lint-architecture, schema-validate]
    if: |
      github.event_name == 'pull_request' && 
      (needs.selfcheck.result == 'failure' || 
       needs.lint-architecture.result == 'failure' || 
       needs.schema-validate.result == 'failure')
    steps:
      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '⚠️ **Architectural Integrity Check Failed**\n\nThis PR has failed architectural integrity checks. Please review the failures and fix them before merging.\n\nSee workflow run for details.'
            })
