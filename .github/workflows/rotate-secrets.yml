name: Rotate Secrets

on:
  schedule:
    # Run weekly on Sunday at 2 AM UTC
    - cron: '0 2 * * 0'
  workflow_dispatch:
    inputs:
      force:
        description: 'Force rotation of all secrets'
        required: false
        default: 'false'
        type: boolean

jobs:
  rotate-secrets:
    name: Rotate Secrets
    runs-on: ubuntu-latest
    environment: production
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Vercel CLI
        run: npm install -g vercel@latest

      - name: Rotate secrets
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        run: |
          npm run ops:rotate-secrets -- --dry-run || echo "Dry run completed"
          
          # Only actually rotate if not dry-run and approved
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            npm run ops:rotate-secrets || exit 1
          else
            echo "Scheduled rotation skipped (use workflow_dispatch to actually rotate)"
          fi

      - name: Notify on failure
        if: failure()
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'Secrets rotation failed',
              body: 'Automated secrets rotation failed. Please review and rotate manually.',
              labels: ['security', 'automation']
            })
