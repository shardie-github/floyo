name: Supabase Delta Migrate & Verify
on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - "scripts/agents/generate_delta_migration.ts"
      - "supabase/migrations/**.sql"
jobs:
  migrate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: 20 }
      - run: npm ci || true
      - name: Build Delta
        env: { SUPABASE_DB_URL: ${{ secrets.SUPABASE_DB_URL }} }
        run: node scripts/agents/generate_delta_migration.ts
      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with: { version: latest }
      - name: Apply via Supabase CLI
        env: { SUPABASE_DB_URL: ${{ secrets.SUPABASE_DB_URL }} }
        run: supabase db push --db-url "$SUPABASE_DB_URL" --include-all
      - name: Fallback psql per-file if CLI fails
        if: failure()
        env: { SUPABASE_DB_URL: ${{ secrets.SUPABASE_DB_URL }} }
        run: |
          for f in $(ls -1 supabase/migrations/*.sql | sort); do
            echo "Applying $f"
            psql "$SUPABASE_DB_URL" -v ON_ERROR_STOP=1 -f "$f"
          done
      - name: Verify
        env: { DATABASE_URL: ${{ secrets.SUPABASE_DB_URL }} }
        run: node scripts/agents/verify_db.ts
      - name: System Doctor
        env: { SUPABASE_DB_URL: ${{ secrets.SUPABASE_DB_URL }} }
        run: node scripts/agents/system_doctor.ts
      - name: Write status.json
        if: always()
        env:
          TZ: America/Toronto
          SUPABASE_DB_URL: ${{ secrets.SUPABASE_DB_URL }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN || github.token }}
        run: node scripts/agents/write_status_json.ts || true
