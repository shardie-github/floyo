name: PR Preview & Quality Gates

# NOTE: This workflow provides additional quality gates (Lighthouse, Pa11y) beyond the main Frontend CI/CD workflow.
# The primary frontend deployment workflow is frontend-deploy.yml.
# This workflow runs quality checks and creates preview deployments with accessibility/performance testing.

on:
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  preview:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    env:
      NEXT_TELEMETRY_DISABLED: 1
      NEXT_PUBLIC_SITE_URL: http://localhost:3000
      SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
      SUPABASE_PROJECT_REF: ${{ secrets.SUPABASE_PROJECT_REF }}
      SUPABASE_DB_PASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}
      VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
      VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
      VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install
        run: npm ci

      - name: Typecheck & Lint
        run: |
          set -euo pipefail
          npm run -s typecheck
          npm run -s lint

      - name: Build Next.js
        run: npm run build

      - name: Validate required secrets
        run: |
          set -euo pipefail
          echo "ðŸ” Validating required secrets..."
          
          MISSING_SECRETS=()
          
          if [ -z "$VERCEL_TOKEN" ] || [ "$VERCEL_TOKEN" == "" ]; then
            MISSING_SECRETS+=("VERCEL_TOKEN")
          fi
          
          if [ -z "$VERCEL_ORG_ID" ] || [ "$VERCEL_ORG_ID" == "" ]; then
            MISSING_SECRETS+=("VERCEL_ORG_ID")
          fi
          
          if [ -z "$VERCEL_PROJECT_ID" ] || [ "$VERCEL_PROJECT_ID" == "" ]; then
            MISSING_SECRETS+=("VERCEL_PROJECT_ID")
          fi
          
          if [ ${#MISSING_SECRETS[@]} -gt 0 ]; then
            echo "âŒ Missing required secrets: ${MISSING_SECRETS[*]}"
            echo ""
            echo "Please set the following secrets in GitHub:"
            echo "  - Settings â†’ Secrets and variables â†’ Actions"
            echo ""
            for secret in "${MISSING_SECRETS[@]}"; do
              echo "  - $secret"
            done
            echo ""
            echo "See docs/env-and-secrets.md for setup instructions."
            exit 1
          fi
          
          echo "âœ… All required secrets are present"

      - name: Start server
        run: npm run start-ci &
      
      - name: Wait for server
        run: npx wait-on http://localhost:3000

      - name: Lighthouse (mobile)
        run: npm run lhci

      - name: Accessibility (Pa11y axe)
        run: npm run a11y

      - name: Upload QA Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: qa-reports
          path: |
            .lighthouseci
            pa11y-ci-results.json

      # OPTIONAL: Dry-run Supabase schema check (no changes applied)
      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
      - name: Supabase login/link (dry-run)
        run: |
          npm run supa:login || echo "âš ï¸ Supabase login failed (optional)"
          npm run supa:link || echo "âš ï¸ Supabase link failed (optional)"
          npm run supa:status || echo "âš ï¸ Supabase status check failed (optional)"

      - name: Vercel Pull & Build (Preview)
        run: |
          set -euo pipefail
          echo "ðŸ“¥ Pulling Vercel configuration for preview environment..."
          
          if ! npm run vercel:pull; then
            echo "âŒ Failed to pull Vercel configuration"
            echo "See docs/vercel-troubleshooting.md for troubleshooting steps."
            exit 1
          fi
          
          echo "ðŸ”¨ Building with Vercel..."
          if ! npm run vercel:build; then
            echo "âŒ Vercel build failed"
            echo "See docs/vercel-troubleshooting.md for troubleshooting steps."
            exit 1
          fi
          
          echo "ðŸš€ Deploying preview..."
          if ! npm run vercel:deploy:preview; then
            echo "âŒ Preview deployment failed"
            echo "See docs/vercel-troubleshooting.md for troubleshooting steps."
            exit 1
          fi
          
          echo "âœ… Preview deployment completed"

      - name: Comment Preview URL
        if: always()
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          recreate: true
          path: .vercel-url.txt
          message: |
            ## ðŸš€ Preview Deployment (Quality Gates)
            
            This preview includes additional quality checks (Lighthouse, Pa11y).
            
            **Preview URL:** See file `.vercel-url.txt` for deployment URL.
            
            > Note: Primary preview deployment is handled by `frontend-deploy.yml`.
