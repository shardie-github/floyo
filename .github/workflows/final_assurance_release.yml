name: Final Assurance → Release (Gated)

on:
  workflow_dispatch:
    inputs:
      semver_bump:
        description: 'Semver bump type (major/minor/patch)'
        required: false
        default: 'patch'
  schedule:
    - cron: "0 5 * * *"

permissions:
  contents: write
  pull-requests: read

env:
  READINESS_THRESHOLD: "90"

jobs:
  verify-and-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Tooling
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq moreutils zip
          pipx install cyclonedx-bom || true
          pipx ensurepath || true
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Ensure governance docs
        run: |
          test -f SECURITY.md || echo "# Security Policy" > SECURITY.md
          mkdir -p .github
          test -f .github/CODEOWNERS || echo "* @repo-maintainers" > .github/CODEOWNERS
          test -f SUPPORT.md || echo "# Support\nUse GitHub Issues." > SUPPORT.md
          test -f CONTRIBUTING.md || echo "# Contributing\nSee README." > CONTRIBUTING.md

      - name: Compute readiness
        run: |
          python3 infra/release/compute_readiness.py || echo "Readiness below threshold"

      - name: Stop if readiness below threshold
        id: gate
        run: |
          SCORE=$(jq -r '.score' docs/audit_investor_suite/READINESS.json 2>/dev/null || echo 0)
          BLOCKERS=$(jq -r '.critical_blockers' docs/audit_investor_suite/READINESS.json 2>/dev/null || echo 999)
          GATED=$(jq -r '.gated' docs/audit_investor_suite/READINESS.json 2>/dev/null || echo false)
          echo "score=$SCORE" >> $GITHUB_OUTPUT
          echo "blockers=$BLOCKERS" >> $GITHUB_OUTPUT
          echo "gated=$GATED" >> $GITHUB_OUTPUT
          if [ "$GATED" != "true" ]; then
            echo "Readiness gate FAILED: Score=$SCORE, Blockers=$BLOCKERS"
            echo "Refusing release. See READINESS.json for details."
            exit 0
          fi

      - name: Generate changelog and bundle
        if: ${{ steps.gate.outputs.gated == 'true' }}
        run: |
          bash infra/release/changelog.sh
          bash infra/release/bundle_release.sh

      - name: Compute next tag
        id: semver
        if: ${{ steps.gate.outputs.gated == 'true' }}
        run: |
          TYPE="${{ github.event.inputs.semver_bump || 'patch' }}"
          TAG=$(bash infra/release/semver_next.sh "$TYPE")
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "Next tag: $TAG"

      - name: Create tag
        if: ${{ steps.gate.outputs.gated == 'true' }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "${{ steps.semver.outputs.tag }}" -m "Release ${{ steps.semver.outputs.tag }} – Final Assurance"
          git push origin "${{ steps.semver.outputs.tag }}"

      - name: Publish GitHub Release
        if: ${{ steps.gate.outputs.gated == 'true' }}
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.semver.outputs.tag }}
          name: ${{ steps.semver.outputs.tag }} – Final Assurance
          body_path: RELEASE_NOTES.md
          files: |
            dist/investor_pack.zip
            dist/SBOM/*
            dist/SHA256SUMS.txt

      - name: Seed vNext roadmap
        if: ${{ steps.gate.outputs.gated == 'true' }}
        run: |
          echo "# vNext Milestones" > NEXT_MILESTONES.md
          echo "" >> NEXT_MILESTONES.md
          echo "- Hardening: Address remaining critical security issues" >> NEXT_MILESTONES.md
          echo "- Performance budget: Establish and monitor performance metrics" >> NEXT_MILESTONES.md
          echo "- GTM experiments: Launch go-to-market initiatives" >> NEXT_MILESTONES.md
          echo "- Compliance tasks: Complete privacy/terms documentation" >> NEXT_MILESTONES.md
          git add NEXT_MILESTONES.md CHANGELOG.md RELEASE_NOTES.md dist/** || true
          git commit -m "chore(release): add NEXT_MILESTONES & artifacts" || true
          git push || true

      - name: Upload closure report
        uses: actions/upload-artifact@v4
        with:
          name: final-closure
          path: |
            docs/audit_investor_suite/PROJECT_CLOSURE_SUMMARY.md
            docs/audit_investor_suite/READINESS.json
            CHANGELOG.md
            RELEASE_NOTES.md
            dist/**
          retention-days: 60
          if-no-files-found: warn
