name: Daily Metrics Update

on:
  schedule:
    # Run daily at 2 AM UTC to keep metrics fresh
    - cron: '0 2 * * *'
  workflow_dispatch:

concurrency:
  group: daily-metrics-update
  cancel-in-progress: false

jobs:
  update-metrics:
    name: Daily Metrics Update
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: package-lock.json

      - name: Install dependencies
        run: |
          set -euo pipefail
          npm ci

      - name: Configure Git
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

      - name: Fetch Metrics & Update Documentation
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          CI: 'true'
        run: |
          set -euo pipefail
          
          # Check if required secrets are set
          if [ -z "${SUPABASE_URL:-}" ] && [ -z "${NEXT_PUBLIC_SUPABASE_URL:-}" ]; then
            echo "‚ö†Ô∏è  SUPABASE_URL or NEXT_PUBLIC_SUPABASE_URL not set"
            echo "Skipping metrics update - set secrets to enable"
            exit 0
          fi
          
          if [ -z "${SUPABASE_SERVICE_ROLE_KEY:-}" ]; then
            echo "‚ö†Ô∏è  SUPABASE_SERVICE_ROLE_KEY not set"
            echo "Skipping metrics update - set secret to enable"
            exit 0
          fi
          
          # Use NEXT_PUBLIC_SUPABASE_URL if SUPABASE_URL not set
          if [ -z "${SUPABASE_URL:-}" ]; then
            export SUPABASE_URL="$NEXT_PUBLIC_SUPABASE_URL"
          fi
          
          echo "üìä Fetching daily metrics from Supabase..."
          
          # Run metrics fetch script
          npm run metrics:fetch || {
            echo "‚ö†Ô∏è  Metrics fetch failed"
            exit 0  # Don't fail on error
          }

      - name: Commit and push changes
        run: |
          set -euo pipefail
          if [ -n "$(git status --porcelain)" ]; then
            git add yc/*.md dataroom/*.md docs/*.md || true
            git commit -m "chore: Auto-update daily metrics [skip ci]" || exit 0
            git push origin main || exit 0
            echo "‚úÖ Metrics updated and pushed to main"
          else
            echo "‚úÖ No changes to commit"
          fi
