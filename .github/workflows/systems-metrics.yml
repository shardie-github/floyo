name: Systems Metrics Snapshot

on:
  schedule:
    # Every Monday at 04:40 UTC
    - cron: '40 4 * * 1'
  workflow_dispatch:

jobs:
  systems-metrics:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Calculate metrics
        id: metrics
        run: |
          # Calculate lead time (simplified - would use actual PR data in production)
          LEAD_TIME=$(echo "2.5" | bc)
          CYCLE_TIME=$(echo "1.5" | bc)
          
          # Get PR count >48h
          PR_COUNT=$(gh pr list --state open --json createdAt --jq '[.[] | select((.createdAt | fromdateiso8601) < (now - 172800))] | length' || echo "0")
          
          # Get failed CI runs (last 7 days)
          CI_FAILURES=$(gh run list --limit 100 --json conclusion --jq '[.[] | select(.conclusion == "failure")] | length' || echo "0")
          
          # Calculate MTTR (simplified - would use incident data)
          MTTR=$(echo "45" | bc)
          
          echo "lead_time=$LEAD_TIME" >> $GITHUB_OUTPUT
          echo "cycle_time=$CYCLE_TIME" >> $GITHUB_OUTPUT
          echo "pr_count=$PR_COUNT" >> $GITHUB_OUTPUT
          echo "ci_failures=$CI_FAILURES" >> $GITHUB_OUTPUT
          echo "mttr=$MTTR" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate metrics snapshot
        run: |
          DATE=$(date -I)
          mkdir -p systems/history
          
          cat > systems/history/$DATE.json << EOF
          {
            "date": "$DATE",
            "metrics": {
              "lead_time": {
                "value": ${{ steps.metrics.outputs.lead_time }},
                "unit": "hours",
                "target": 2
              },
              "cycle_time": {
                "value": ${{ steps.metrics.outputs.cycle_time }},
                "unit": "hours",
                "target": 1.25
              },
              "pr_queue_length": {
                "value": ${{ steps.metrics.outputs.pr_count }},
                "unit": "count",
                "target": 1
              },
              "ci_failure_rate": {
                "value": ${{ steps.metrics.outputs.ci_failures }},
                "unit": "count",
                "target": 0
              },
              "mttr": {
                "value": ${{ steps.metrics.outputs.mttr }},
                "unit": "minutes",
                "target": 30
              }
            }
          }
          EOF

      - name: Update scorecard
        run: |
          # This would update systems/scorecard.md with trends
          # For now, just create a placeholder
          echo "Scorecard update would go here"
          # In production, would:
          # 1. Load history
          # 2. Calculate trends
          # 3. Update scorecard.md with red/amber/green badges

      - name: Commit metrics
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add systems/history/*.json systems/scorecard.md
          git diff --staged --quiet || git commit -m "chore: update systems metrics snapshot [skip ci]"
          git push || echo "No changes to commit"
