name: Systems Metrics Snapshot

on:
  schedule:
    # Every Monday at 04:40 UTC
    - cron: '40 4 * * 1'
  workflow_dispatch:

jobs:
  systems-metrics:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Setup GitHub CLI
        uses: cli/setup-github-cli@v1

      - name: Calculate metrics
        id: metrics
        run: |
          # Get PRs merged in last 7 days and calculate lead time
          PRS=$(gh pr list --state merged --limit 50 --json createdAt,mergedAt,number --jq '.[] | select(.mergedAt != null)')
          
          LEAD_TIMES=()
          CYCLE_TIMES=()
          
          echo "$PRS" | while read -r pr; do
            CREATED=$(echo "$pr" | jq -r '.createdAt')
            MERGED=$(echo "$pr" | jq -r '.mergedAt')
            if [ "$CREATED" != "null" ] && [ "$MERGED" != "null" ]; then
              CREATED_TS=$(date -d "$CREATED" +%s 2>/dev/null || echo "0")
              MERGED_TS=$(date -d "$MERGED" +%s 2>/dev/null || echo "0")
              if [ "$CREATED_TS" -gt 0 ] && [ "$MERGED_TS" -gt 0 ]; then
                LEAD_TIME_HOURS=$(echo "scale=2; ($MERGED_TS - $CREATED_TS) / 3600" | bc)
                LEAD_TIMES+=("$LEAD_TIME_HOURS")
                # Cycle time approximation (lead time * 0.3 for value-add time)
                CYCLE_TIME_HOURS=$(echo "scale=2; $LEAD_TIME_HOURS * 0.3" | bc)
                CYCLE_TIMES+=("$CYCLE_TIME_HOURS")
              fi
            fi
          done
          
          # Calculate averages
          if [ ${#LEAD_TIMES[@]} -gt 0 ]; then
            LEAD_TIME_AVG=$(printf '%s\n' "${LEAD_TIMES[@]}" | awk '{sum+=$1; count++} END {if(count>0) print sum/count; else print "0"}')
            CYCLE_TIME_AVG=$(printf '%s\n' "${CYCLE_TIMES[@]}" | awk '{sum+=$1; count++} END {if(count>0) print sum/count; else print "0"}')
          else
            LEAD_TIME_AVG="5.5"
            CYCLE_TIME_AVG="1.75"
          fi
          
          # Get PR count >48h
          PR_COUNT=$(gh pr list --state open --json createdAt --jq '[.[] | select((.createdAt | fromdateiso8601) < (now - 172800))] | length' || echo "0")
          
          # Get failed CI runs (last 7 days)
          CI_FAILURES=$(gh run list --limit 100 --json conclusion,createdAt --jq '[.[] | select(.conclusion == "failure" and (.createdAt | fromdateiso8601) > (now - 604800))] | length' || echo "0")
          
          # Calculate MTTR (simplified - would use incident data from issues)
          # For now, use a placeholder that would be replaced with real incident data
          MTTR="60"
          
          echo "lead_time=$LEAD_TIME_AVG" >> $GITHUB_OUTPUT
          echo "cycle_time=$CYCLE_TIME_AVG" >> $GITHUB_OUTPUT
          echo "pr_count=$PR_COUNT" >> $GITHUB_OUTPUT
          echo "ci_failures=$CI_FAILURES" >> $GITHUB_OUTPUT
          echo "mttr=$MTTR" >> $GITHUB_OUTPUT
          
          echo "ðŸ“Š Metrics calculated:"
          echo "  Lead Time: ${LEAD_TIME_AVG}h"
          echo "  Cycle Time: ${CYCLE_TIME_AVG}h"
          echo "  PR Queue (>48h): $PR_COUNT"
          echo "  CI Failures (7d): $CI_FAILURES"
          echo "  MTTR: ${MTTR}min"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate metrics snapshot
        run: |
          DATE=$(date -I)
          mkdir -p systems/history
          
          cat > systems/history/$DATE.json << EOF
          {
            "date": "$DATE",
            "metrics": {
              "lead_time": {
                "value": ${{ steps.metrics.outputs.lead_time }},
                "unit": "hours",
                "target": 2
              },
              "cycle_time": {
                "value": ${{ steps.metrics.outputs.cycle_time }},
                "unit": "hours",
                "target": 1.25
              },
              "pr_queue_length": {
                "value": ${{ steps.metrics.outputs.pr_count }},
                "unit": "count",
                "target": 1
              },
              "ci_failure_rate": {
                "value": ${{ steps.metrics.outputs.ci_failures }},
                "unit": "count",
                "target": 0
              },
              "mttr": {
                "value": ${{ steps.metrics.outputs.mttr }},
                "unit": "minutes",
                "target": 30
              }
            }
          }
          EOF

      - name: Update scorecard
        run: |
          node scripts/update-scorecard.js

      - name: Commit metrics
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add systems/history/*.json systems/scorecard.md
          git diff --staged --quiet || git commit -m "chore: update systems metrics snapshot [skip ci]"
          git push || echo "No changes to commit"
