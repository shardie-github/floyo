name: Pre-Merge Validation Checks

on:
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:

jobs:
  pre-merge-checks:
    name: Pre-Merge Validation
    runs-on: ubuntu-latest
    # Run in parallel with other checks
    concurrency:
      group: pre-merge-${{ github.ref }}
      cancel-in-progress: false
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for coverage comparison

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Type Check
        id: typecheck
        run: |
          echo "Running type check..."
          npm run type-check 2>&1 | tee typecheck-output.txt
          TYPE_ERRORS=$(grep -c "error TS" typecheck-output.txt || echo "0")
          echo "type_errors=$TYPE_ERRORS" >> $GITHUB_OUTPUT
          if [ "$TYPE_ERRORS" -gt "0" ]; then
            echo "‚ùå Type check failed with $TYPE_ERRORS errors"
            exit 1
          fi
          echo "‚úÖ Type check passed"

      - name: Test Coverage Check
        id: coverage
        run: |
          echo "Running test coverage check..."
          # Run tests with coverage
          npm run test -- --coverage --coverageThreshold='{"global":{"branches":80,"functions":80,"lines":80,"statements":80}}' || {
            echo "‚ö†Ô∏è  Test coverage below 80% threshold"
            echo "coverage_below_threshold=true" >> $GITHUB_OUTPUT
            # Don't fail, just warn for now (gradual rollout)
            exit 0
          }
          echo "‚úÖ Test coverage check passed"
          echo "coverage_below_threshold=false" >> $GITHUB_OUTPUT

      - name: UX Copy Linting
        id: ux-copy
        run: |
          echo "Checking UX copy for banned phrases..."
          BANNED_PHRASES=("click here" "please note")
          FOUND_BANNED=false
          
          # Check TSX/TS files for banned phrases
          for phrase in "${BANNED_PHRASES[@]}"; do
            if grep -r -i "$phrase" frontend/ --include="*.tsx" --include="*.ts" --include="*.json" 2>/dev/null; then
              echo "‚ùå Found banned phrase: '$phrase'"
              FOUND_BANNED=true
            fi
          done
          
          if [ "$FOUND_BANNED" = true ]; then
            echo "‚ùå UX copy linting failed - banned phrases found"
            echo "banned_phrases_found=true" >> $GITHUB_OUTPUT
            # Don't fail, just warn for now (gradual rollout)
            exit 0
          fi
          
          echo "‚úÖ UX copy linting passed"
          echo "banned_phrases_found=false" >> $GITHUB_OUTPUT

      - name: Bundle Size Check
        id: bundle-size
        run: |
          echo "Checking bundle size..."
          npm run build
          
          # Check bundle sizes (adjust paths based on your build output)
          if [ -d "frontend/.next" ]; then
            # Find main bundle files
            MAIN_BUNDLE=$(find frontend/.next -name "*.js" -type f -exec ls -lh {} \; | sort -k5 -hr | head -1 | awk '{print $5}')
            echo "Main bundle size: $MAIN_BUNDLE"
            
            # Convert to bytes for comparison (250KB = 256000 bytes)
            SIZE_BYTES=$(echo "$MAIN_BUNDLE" | sed 's/K/ * 1024/' | sed 's/M/ * 1024 * 1024/' | bc 2>/dev/null || echo "0")
            MAX_SIZE=256000
            
            if [ "$SIZE_BYTES" -gt "$MAX_SIZE" ]; then
              echo "‚ö†Ô∏è  Bundle size exceeds 250KB threshold"
              echo "bundle_size_exceeded=true" >> $GITHUB_OUTPUT
              # Don't fail, just warn for now (gradual rollout)
              exit 0
            fi
            
            echo "‚úÖ Bundle size check passed"
            echo "bundle_size_exceeded=false" >> $GITHUB_OUTPUT
          else
            echo "‚ö†Ô∏è  Could not find build output"
            echo "bundle_size_exceeded=false" >> $GITHUB_OUTPUT
          fi

      - name: Comment PR with Results
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const typeErrors = '${{ steps.typecheck.outputs.type_errors }}';
            const coverageBelow = '${{ steps.coverage.outputs.coverage_below_threshold }}';
            const bannedPhrases = '${{ steps.ux-copy.outputs.banned_phrases_found }}';
            const bundleExceeded = '${{ steps.bundle-size.outputs.bundle_size_exceeded }}';
            
            let comment = '## üîç Pre-Merge Validation Results\n\n';
            
            // Type check
            if (typeErrors === '0') {
              comment += '‚úÖ **Type Check:** Passed\n';
            } else {
              comment += `‚ùå **Type Check:** Failed (${typeErrors} errors)\n`;
            }
            
            // Coverage
            if (coverageBelow === 'false') {
              comment += '‚úÖ **Test Coverage:** ‚â•80%\n';
            } else {
              comment += '‚ö†Ô∏è  **Test Coverage:** Below 80% threshold\n';
            }
            
            // UX Copy
            if (bannedPhrases === 'false') {
              comment += '‚úÖ **UX Copy:** No banned phrases\n';
            } else {
              comment += '‚ö†Ô∏è  **UX Copy:** Banned phrases detected\n';
            }
            
            // Bundle Size
            if (bundleExceeded === 'false') {
              comment += '‚úÖ **Bundle Size:** Within limits\n';
            } else {
              comment += '‚ö†Ô∏è  **Bundle Size:** Exceeds 250KB threshold\n';
            }
            
            comment += '\n---\n';
            comment += '_Note: Warnings do not block merge during gradual rollout. They will become required soon._';
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
