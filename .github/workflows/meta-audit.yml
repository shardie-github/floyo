name: Meta-Architect Audit (Scheduled + Pre-Release)
on:
  schedule: [ { cron: '40 12 * * 1' } ]   # Mondays 07:40 America/Toronto
  push: { tags: [ 'v*' ] }
  workflow_dispatch:
permissions: { contents: write, pull-requests: write }
jobs:
  meta-audit:
    runs-on: ubuntu-latest
    env: { NEXT_TELEMETRY_DISABLED: 1, ANALYZE: 'false' }
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: 20, cache: npm }
      - run: npm ci
      - name: Generate Meta Audit (reports + preview patches only)
        run: |
          node scripts/meta-architect/scan.js
          node scripts/meta-architect/depgraph.js
          node scripts/meta-architect/api-inventory.js
          node scripts/meta-architect/plan.js
      - uses: actions/upload-artifact@v4
        with:
          name: meta-audit-artifacts
          path: |
            docs/architecture/**
            patches/preview/**
      - name: Create PR with Findings
        uses: peter-evans/create-pull-request@v6
        with:
          title: "meta: weekly audit & pre-release hardening"
          commit-message: "meta(audit): add reports + preview patches"
          body: |
            Auto-generated by Meta-Architect Audit.
            Reports → /docs/architecture
            Patches → /patches/preview
            Rollback → /docs/architecture/rollback.sh
          branch: chore/meta-audit/${{ github.run_id }}
          labels: meta, audit, refactor, docs, safe-change
          delete-branch: true
