name: Render Business Docs to PDF

on:
  push:
    branches:
      - main
    paths:
      - 'docs/business/**/*.md'
  workflow_dispatch:
  pull_request:
    branches:
      - main
    paths:
      - 'docs/business/**/*.md'

jobs:
  render-pdfs:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Marp CLI
        run: npm install -g @marp-team/marp-cli

      - name: Create PDF output directory
        run: mkdir -p docs/business/_pdf

      - name: Render Markdown files to PDF
        run: |
          find docs/business -name "*.md" -type f | while read file; do
            # Skip README and files starting with underscore
            if [[ ! "$file" =~ README|^_ ]]; then
              # Get relative path from docs/business
              rel_path="${file#docs/business/}"
              # Create output directory structure
              output_dir="docs/business/_pdf/$(dirname "$rel_path")"
              mkdir -p "$output_dir"
              # Generate PDF filename
              pdf_name="$(basename "$rel_path" .md).pdf"
              # Render to PDF
              marp "$file" --pdf --output "$output_dir/$pdf_name" --theme docs/.theme/marp-config.json || echo "Warning: Failed to render $file"
            fi
          done

      - name: Upload PDFs as artifact
        uses: actions/upload-artifact@v4
        with:
          name: business-docs-pdfs
          path: docs/business/_pdf/
          retention-days: 30

      - name: Check for PDF generation errors
        run: |
          pdf_count=$(find docs/business/_pdf -name "*.pdf" | wc -l)
          md_count=$(find docs/business -name "*.md" -type f ! -name "README.md" ! -name "_*" | wc -l)
          if [ "$pdf_count" -lt "$md_count" ]; then
            echo "Warning: Some PDFs may not have been generated. Expected: $md_count, Generated: $pdf_count"
          else
            echo "Success: Generated $pdf_count PDFs from $md_count Markdown files"
          fi

      - name: Lint CAD currency consistency
        run: |
          # Check for CAD currency consistency in markdown files
          files_without_cad=$(grep -r "CAD\|\\$" docs/business --include="*.md" | grep -v "CAD" | grep -v "\\$.*CAD" | wc -l || true)
          if [ "$files_without_cad" -gt 0 ]; then
            echo "Warning: Some files may not consistently use CAD currency"
          else
            echo "Success: CAD currency consistency check passed"
          fi

      - name: Check for broken links
        run: |
          # Basic link checking (markdown links)
          broken_links=$(grep -r "\\[.*\\]\\(.*\\)" docs/business --include="*.md" | grep -v "http" | grep -v "mailto" | wc -l || true)
          if [ "$broken_links" -gt 0 ]; then
            echo "Info: Found $broken_links potential links to check"
          fi
