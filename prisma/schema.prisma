// Prisma Schema with WASM support
// This uses Prisma WASM for Termux/ARM64 compatibility

generator client {
  provider = "prisma-client-js"
  previewFeatures = ["wasm"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User accounts
model User {
  id            String    @id @default(uuid())
  email         String    @unique
  emailVerified Boolean   @default(false)
  passwordHash  String?   // Nullable for OAuth users
  name          String?
  image         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  // Relations
  events        Event[]
  patterns      Pattern[]
  relationships Relationship[]
  sessions      Session[]
  subscriptions Subscription[]
  utmTracks     UTMTrack[]
  cohorts       Cohort[]
  
  @@index([email])
  @@map("users")
}

// Authentication sessions
model Session {
  id           String   @id @default(uuid())
  userId       String
  token        String   @unique
  expiresAt    DateTime
  createdAt    DateTime @default(now())
  
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([token])
  @@map("sessions")
}

// File system events
model Event {
  id          String   @id @default(uuid())
  userId      String
  filePath    String
  eventType   String   // created, modified, accessed, deleted
  tool        String?
  timestamp   DateTime @default(now())
  metadata    Json?
  
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId, timestamp])
  @@index([filePath])
  @@map("events")
}

// Detected patterns
model Pattern {
  id           String   @id @default(uuid())
  userId       String
  fileExtension String
  count        Int      @default(0)
  lastUsed     DateTime @default(now())
  tools        String[]
  updatedAt    DateTime @updatedAt
  
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([userId, fileExtension])
  @@index([userId])
  @@map("patterns")
}

// File relationships
model Relationship {
  id           String   @id @default(uuid())
  userId       String
  sourceFile   String
  targetFile   String
  relationType String
  weight       Float    @default(1.0)
  lastSeen     DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([userId, sourceFile, targetFile])
  @@index([userId])
  @@map("relationships")
}

// Subscriptions and billing
model Subscription {
  id            String   @id @default(uuid())
  userId        String   @unique
  plan          String   @default("free") // free, pro, enterprise
  status        String   @default("active") // active, canceled, past_due
  stripeId      String?  @unique
  currentPeriodStart DateTime?
  currentPeriodEnd   DateTime?
  cancelAtPeriodEnd Boolean @default(false)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@map("subscriptions")
}

// UTM tracking for growth
model UTMTrack {
  id          String   @id @default(uuid())
  userId      String
  source      String?
  medium      String?
  campaign    String?
  term        String?
  content     String?
  firstTouch  Boolean  @default(true)
  lastTouch   Boolean  @default(false)
  timestamp   DateTime @default(now())
  
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId, timestamp])
  @@index([campaign])
  @@map("utm_tracks")
}

// Cohort analysis
model Cohort {
  id          String   @id @default(uuid())
  userId      String
  cohortMonth String   // YYYY-MM
  acquiredAt  DateTime
  createdAt   DateTime @default(now())
  
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([userId, cohortMonth])
  @@index([cohortMonth])
  @@map("cohorts")
}

// Feature flags
model FeatureFlag {
  id          String   @id @default(uuid())
  key         String   @unique
  enabled     Boolean  @default(false)
  description String?
  metadata    Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@map("feature_flags")
}

// Pricing offers
model Offer {
  id          String   @id @default(uuid())
  key         String   @unique
  name        String
  description String?
  planType    String   // free, pro, enterprise
  discount    Float?   // Percentage discount
  validFrom   DateTime
  validTo     DateTime?
  enabled     Boolean  @default(true)
  metadata    Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@map("offers")
}

// Audit logs for compliance
model AuditLog {
  id          String   @id @default(uuid())
  userId      String?
  action      String
  resource    String?
  resourceId  String?
  metadata    Json?
  ipAddress   String?
  userAgent   String?
  timestamp   DateTime @default(now())
  
  @@index([userId, timestamp])
  @@index([action])
  @@map("audit_logs")
}

// Data retention policies
model RetentionPolicy {
  id          String   @id @default(uuid())
  tableName   String
  retentionDays Int
  enabled     Boolean  @default(true)
  lastRun     DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@unique([tableName])
  @@map("retention_policies")
}
