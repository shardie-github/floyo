> Archived on 2025-11-12. Superseded by: (see docs/final index)

# Contracts vs Implementation Analysis

**Generated:** 2024-12-19  
**Scope:** API contracts (OpenAPI), database schema, and implementation drift

## OpenAPI Contract Analysis

### Contract Source
- **Location:** Auto-generated by FastAPI (`backend/main.py:120-171`)
- **Endpoint:** `/openapi.json`, `/docs` (Swagger UI)
- **Status:** ✅ Auto-generated from code (no manual contract file)

### Contract Drift: None
- FastAPI auto-generates OpenAPI schema from route definitions
- No manual OpenAPI file to drift from
- **Recommendation:** Export OpenAPI schema and version it for API consumers

## API Endpoint Coverage

### Endpoints Declared in Documentation vs Implemented

| Endpoint | Method | Documented | Implemented | Status | Notes |
|----------|--------|------------|-------------|--------|-------|
| `/api/auth/register` | POST | ✅ | ✅ | Aligned | `main.py:501` |
| `/api/auth/login` | POST | ✅ | ✅ | Aligned | `main.py:582` |
| `/api/auth/refresh` | POST | ✅ | ✅ | Aligned | `main.py:628` |
| `/api/auth/me` | GET | ✅ | ✅ | Aligned | `main.py:752` |
| `/api/auth/profile` | PUT | ✅ | ✅ | Aligned | `main.py:758` |
| `/api/auth/verify-email/{token}` | GET | ✅ | ✅ | Aligned | `main.py:783` |
| `/api/auth/resend-verification` | POST | ✅ | ✅ | Aligned | `main.py:805` |
| `/api/auth/forgot-password` | POST | ✅ | ✅ | Aligned | `main.py:840` |
| `/api/auth/reset-password` | POST | ✅ | ✅ | Aligned | `main.py:866` |
| `/api/auth/change-password` | POST | ✅ | ✅ | Aligned | `main.py:903` |
| `/api/auth/sessions` | GET | ✅ | ✅ | Aligned | `main.py:691` |
| `/api/auth/sessions/{session_id}` | DELETE | ✅ | ✅ | Aligned | `main.py:715` |
| `/api/auth/sessions` | DELETE | ✅ | ✅ | Aligned | `main.py:736` |
| `/api/events` | POST | ✅ | ✅ | Aligned | `main.py:973` |
| `/api/events` | GET | ✅ | ✅ | Aligned | `main.py:1045` |
| `/api/events/batch` | POST | ✅ | ✅ | Aligned | `main.py:1015` |
| `/api/events/upload` | POST | ✅ | ✅ | Aligned | `main.py:930` |
| `/api/events/export` | GET | ✅ | ✅ | Aligned | `main.py:1447` |
| `/api/suggestions` | GET | ✅ | ✅ | Aligned | `main.py:1118` |
| `/api/suggestions/generate` | POST | ✅ | ✅ | Aligned | `main.py:1179` |
| `/api/suggestions/{id}/bookmark` | POST | ✅ | ✅ | Aligned | `main.py:1342` |
| `/api/suggestions/{id}/apply` | POST | ✅ | ✅ | Aligned | `main.py:1372` |
| `/api/suggestions/{id}/dismiss` | POST | ✅ | ✅ | Aligned | `main.py:1396` |
| `/api/patterns` | GET | ✅ | ✅ | Aligned | `main.py:1220` |
| `/api/patterns/export` | GET | ✅ | ✅ | Aligned | `main.py:1420` |
| `/api/stats` | GET | ✅ | ✅ | Aligned | `main.py:1275` |
| `/api/config` | GET | ✅ | ✅ | Aligned | `main.py:1298` |
| `/api/config` | PUT | ✅ | ✅ | Aligned | `main.py:1321` |
| `/api/organizations` | POST | ✅ | ✅ | Aligned | `main.py:1651` |
| `/api/organizations` | GET | ✅ | ✅ | Aligned | `main.py:1669` |
| `/api/organizations/{id}` | PUT | ✅ | ✅ | Aligned | `main.py:1704` |
| `/api/organizations/{id}` | DELETE | ✅ | ✅ | Aligned | `main.py:1737` |
| `/api/organizations/{id}/members` | GET | ✅ | ✅ | Aligned | `main.py:1679` |
| `/api/workflows` | POST | ✅ | ✅ | Aligned | `main.py:1772` |
| `/api/workflows` | GET | ✅ | ✅ | Aligned | `main.py:1886` |
| `/api/workflows/{id}` | GET | ✅ | ✅ | Aligned | `main.py:1898` |
| `/api/workflows/{id}` | PUT | ✅ | ✅ | Aligned | `main.py:1924` |
| `/api/workflows/{id}` | DELETE | ✅ | ✅ | Aligned | `main.py:1977` |
| `/api/workflows/{id}/execute` | POST | ✅ | ✅ | Aligned | `main.py:1852` |
| `/api/workflows/{id}/rollback` | POST | ✅ | ✅ | Aligned | `main.py:1815` |
| `/api/workflows/{id}/executions` | GET | ✅ | ✅ | Aligned | `main.py:2008` |
| `/api/workflows/{id}/versions` | GET | ✅ | ✅ | Aligned | `main.py:2035` |
| `/api/integrations/connectors` | GET | ✅ | ✅ | Aligned | `main.py:2058` |
| `/api/integrations` | GET | ✅ | ✅ | Aligned | `main.py:2075` |
| `/api/integrations` | POST | ✅ | ✅ | Aligned | `main.py:2087` |
| `/api/integrations/{id}` | GET | ✅ | ✅ | Aligned | `main.py:2217` |
| `/api/integrations/{id}` | PUT | ✅ | ✅ | Aligned | `main.py:2141` |
| `/api/integrations/{id}` | DELETE | ✅ | ✅ | Aligned | `main.py:2181` |
| `/api/integrations/{id}/test` | POST | ✅ | ✅ | Aligned | `main.py:2212` |
| `/api/audit-logs` | GET | ✅ | ✅ | Aligned | `main.py:2251` |
| `/api/data/export` | GET | ✅ | ✅ | Aligned | `main.py:1474` |
| `/api/data/delete` | DELETE | ✅ | ✅ | Aligned | `main.py:1551` |
| `/api/data/retention/cleanup` | POST | ✅ | ✅ | Aligned | `main.py:1598` |
| `/health` | GET | ✅ | ✅ | Aligned | `main.py:391` |
| `/health/readiness` | GET | ✅ | ✅ | Aligned | `main.py:401` |
| `/health/liveness` | GET | ✅ | ✅ | Aligned | `main.py:449` |
| `/health/migrations` | GET | ✅ | ✅ | Aligned | `main.py:458` |
| `/ws` | WebSocket | ✅ | ✅ | Aligned | `main.py:2283` |

**Total Endpoints:** 57  
**Status:** ✅ All documented endpoints implemented

### API Versioning Drift

**Expected:** Versioned API routes (`/api/v1/*`)  
**Reality:** 
- Empty stub: `backend/api_v1.py` (8 lines)
- Router created but not used: `backend/main.py:174`
- All routes under `/api/*` (legacy)

**Drift Level:** High  
**Fix:** Move routes to versioned router or remove versioning promise

## Database Schema Drift

### Schema.sql vs Models.py

| Table | In schema.sql | In models.py | Status | Notes |
|-------|--------------|--------------|--------|-------|
| `users` | ✅ | ✅ | Aligned | `schema.sql:5`, `models.py:20` |
| `user_sessions` | ✅ | ✅ | Aligned | `schema.sql:18`, `models.py:53` |
| `events` | ✅ | ✅ | Aligned | `schema.sql:30`, `models.py:69` |
| `patterns` | ✅ | ✅ | Aligned | `schema.sql:43`, `models.py:90` |
| `relationships` | ✅ | ✅ | Aligned | `schema.sql:57`, `models.py:112` |
| `temporal_patterns` | ✅ | ✅ | Aligned | `schema.sql:71`, `models.py:130` |
| `suggestions` | ✅ | ✅ | Aligned | `schema.sql:84`, `models.py:147` |
| `user_configs` | ✅ | ✅ | Aligned | `schema.sql:101`, `models.py:173` |
| `workflows` | ❌ | ✅ | **Drift** | Missing in `schema.sql`, present in `models.py:344` |
| `organizations` | ❌ | ✅ | **Drift** | Missing in `schema.sql`, present in `models.py:190` |
| `organization_members` | ❌ | ✅ | **Drift** | Missing in `schema.sql`, present in `models.py:210` |
| `audit_logs` | ❌ | ✅ | **Drift** | Missing in `schema.sql`, present in `models.py:242` |
| `workflow_versions` | ❌ | ✅ | **Drift** | Missing in `schema.sql`, present in `models.py:266` |
| `workflow_executions` | ❌ | ✅ | **Drift** | Missing in `schema.sql`, present in `models.py:283` |
| `integration_connectors` | ❌ | ✅ | **Drift** | Missing in `schema.sql`, present in `models.py:304` |
| `user_integrations` | ❌ | ✅ | **Drift** | Missing in `schema.sql`, present in `models.py:319` |
| `roles` | ❌ | ✅ | **Drift** | Missing in `schema.sql`, present in `models.py:229` |

**Schema.sql Coverage:** 8/17 tables (47%)  
**Drift Level:** High

### Migration Files vs Models

| Table | Migration | Models | Status |
|-------|-----------|--------|--------|
| `feature_flags` | ✅ (`migrations/add_feature_flags_experiments_fraud.py:21`) | ⚠️ (`backend/feature_flags.py:27`) | **Drift** - Models in separate file |
| `feature_flag_overrides` | ✅ | ⚠️ (`backend/feature_flags.py:43`) | **Drift** - Models in separate file |
| `experiments` | ✅ | ❌ | **Drift** - Models not defined |
| `experiment_participations` | ✅ | ❌ | **Drift** - Models not defined |
| `experiment_events` | ✅ | ❌ | **Drift** - Models not defined |
| `fraud_scores` | ✅ | ⚠️ (`backend/fraud_scoring.py`) | **Drift** - Models in separate file |

**Migration Models Coverage:** 4/6 models defined (67%)  
**Drift Level:** Medium

### RLS Policies (Supabase)

**Location:** `database/schema.sql:138-177`  
**Status:** ⚠️ Policies defined but not used (project uses JWT auth, not Supabase auth)

**Drift:** Policies reference `auth.uid()` which doesn't exist in current setup  
**Fix:** Remove RLS policies or document Supabase-only usage

## Response Schema Mismatches

### Missing Response Models

1. **Organization Endpoints** - Missing `OrganizationMemberResponse` model
   - **Location:** `main.py:1679` (list_org_members)
   - **Current:** Returns raw model objects
   - **Fix:** Add Pydantic response model

2. **Workflow Executions** - Missing `WorkflowExecutionResponse` model
   - **Location:** `main.py:2008` (get_workflow_executions)
   - **Current:** Returns raw model objects
   - **Fix:** Add Pydantic response model

3. **Integration Connectors** - Missing `ConnectorResponse` model
   - **Location:** `main.py:2058` (list_connectors)
   - **Current:** Returns raw model objects
   - **Fix:** Add Pydantic response model

### Status Code Mismatches

**All endpoints aligned** - FastAPI default status codes used correctly

### Auth Requirements

| Endpoint | Auth Required | Status | Notes |
|----------|---------------|--------|-------|
| `/api/auth/*` (except register/login) | ✅ | Aligned | Uses `get_current_user` |
| `/api/events/*` | ✅ | Aligned | Uses `get_current_user` |
| `/api/suggestions/*` | ✅ | Aligned | Uses `get_current_user` |
| `/api/patterns/*` | ✅ | Aligned | Uses `get_current_user` |
| `/health/*` | ❌ | Aligned | Public endpoints |

**Status:** ✅ All endpoints correctly protected

## Database Schema Issues

### Unsafe Defaults

1. **UserIntegration.config** - No encryption
   - **Location:** `database/models.py:328`
   - **Issue:** Credentials stored in plain text JSONB
   - **Risk:** High - Database compromise exposes all API keys
   - **Fix:** Encrypt sensitive fields before storage

2. **Password Reset Token** - No rate limiting at DB level
   - **Location:** `database/models.py:34`
   - **Issue:** Multiple tokens can be generated (rate limited at API level)
   - **Risk:** Medium - Token enumeration
   - **Fix:** Add unique constraint or rate limit at DB level

### Nullable Surprises

1. **User.username** - Nullable but used in unique constraint
   - **Location:** `database/models.py:26`
   - **Issue:** Can have multiple NULL usernames (PostgreSQL allows)
   - **Risk:** Low - Application logic handles uniqueness
   - **Fix:** Add partial unique index if needed

2. **Event.details** - Nullable JSONB
   - **Location:** `database/models.py:79`
   - **Issue:** No validation on JSONB structure
   - **Risk:** Low - Application handles missing details
   - **Fix:** Add JSON schema validation if needed

### N+1 Query Risks

1. **Organization Members** - No eager loading
   - **Location:** `backend/organizations.py:get_organization_members()`
   - **Risk:** Medium - N+1 queries when loading members
   - **Fix:** Use `joinedload()` or `selectinload()`

2. **Workflow Executions** - No eager loading
   - **Location:** `backend/workflow_scheduler.py:177-186`
   - **Risk:** Low - Usually limited to 50 executions
   - **Fix:** Add eager loading if performance issues arise

## ORM vs Migration Diffs

### Alembic Migration Status

**Location:** `backend/main.py:71-103`  
**Check:** Compares current DB revision vs head revision  
**Status:** ✅ Working correctly

### Migration Files

1. **`migrations/add_feature_flags_experiments_fraud.py`**
   - **Status:** ✅ Complete migration
   - **Issue:** Models not in main `models.py`
   - **Fix:** Integrate models or document separate model files

## RLS/Policy Failures

### Supabase RLS Policies

**Location:** `database/schema.sql:138-177`  
**Status:** ⚠️ Not applicable (project uses JWT auth, not Supabase auth)

**Policies Defined:**
- `users` - `auth.uid() = id`
- `events` - `auth.uid() = user_id`
- `patterns` - `auth.uid() = user_id`
- `suggestions` - `auth.uid() = user_id`
- etc.

**Issue:** Policies reference `auth.uid()` which doesn't exist in current setup  
**Fix:** Remove RLS policies or document Supabase-only usage

### Application-Level Policies

**Current:** JWT-based auth in `backend/main.py:361-382`  
**Status:** ✅ Working correctly

## Contract Conformance Gaps

### High Priority

1. **Schema.sql incomplete** - Missing 9/17 tables
   - **Effort:** S (1 hour)
   - **Fix:** Generate from models or archive schema.sql

2. **API versioning not implemented** - Empty stub
   - **Effort:** S (2 hours)
   - **Fix:** Move routes to versioned router or remove versioning

3. **Feature flag models not integrated** - Models in separate file
   - **Effort:** M (2-3 hours)
   - **Fix:** Integrate models into main models.py or document separation

### Medium Priority

4. **Missing response models** - Some endpoints return raw objects
   - **Effort:** S (1-2 hours)
   - **Fix:** Add Pydantic response models

5. **N+1 query risks** - Eager loading not used
   - **Effort:** M (2-3 hours)
   - **Fix:** Add eager loading where needed

### Low Priority

6. **RLS policies not applicable** - Supabase-only policies
   - **Effort:** S (30 minutes)
   - **Fix:** Remove or document Supabase-only usage

## Recommendations

### Immediate (Week 1)
1. **Fix schema.sql** - Generate from models or archive
2. **Implement API versioning** - Move routes to `/api/v1/*` or remove versioning

### Short-term (Week 2-3)
3. **Integrate feature flag models** - Move to main models.py or document
4. **Add missing response models** - Improve API contract clarity

### Medium-term (Week 3-4)
5. **Fix N+1 queries** - Add eager loading
6. **Remove RLS policies** - Or document Supabase-only usage

See `docs/audit/PR_PLAN_CONTRACTS.md` for implementation details.
