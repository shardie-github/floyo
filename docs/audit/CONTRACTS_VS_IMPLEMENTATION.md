# Contracts vs Implementation

## API Contract Analysis

### OpenAPI/Swagger Specification
**Status:** Auto-generated by FastAPI (`/openapi.json`)
**Location:** `backend/main.py:125` (OpenAPI URL configured)

### Endpoint-by-Endpoint Analysis

#### Authentication Endpoints

| Endpoint | Method | Contract | Implementation | Status |
|----------|--------|----------|----------------|--------|
| `/api/auth/register` | POST | 201 Created | Returns 201 ✓ | ✓ |
| `/api/auth/login` | POST | 200 OK, Token | Returns Token ✓ | ✓ |
| `/api/auth/refresh` | POST | 200 OK, Token | Returns Token ✓ | ✓ |
| `/api/auth/me` | GET | 200 OK, User | Returns User ✓ | ✓ |
| `/api/auth/profile` | PUT | 200 OK, User | Returns User ✓ | ✓ |
| `/api/auth/verify-email/{token}` | GET | 200 OK | Returns 200 ✓ | ✓ |
| `/api/auth/resend-verification` | POST | 200 OK | Returns 200 ✓ | ✓ |
| `/api/auth/forgot-password` | POST | 200 OK | Returns 200 ✓ | ✓ |
| `/api/auth/reset-password` | POST | 200 OK | Returns 200 ✓ | ✓ |
| `/api/auth/change-password` | POST | 200 OK | Returns 200 ✓ | ✓ |
| `/api/auth/sessions` | GET | 200 OK, List | Returns List ✓ | ✓ |
| `/api/auth/sessions/{id}` | DELETE | 200 OK | Returns 200 ✓ | ✓ |
| `/api/auth/sessions` | DELETE | 200 OK | Returns 200 ✓ | ✓ |

**Issues:**
- No OpenAPI schema file checked into repo
- Pydantic models defined but not exported as OpenAPI spec file
- **Proposed:** Generate and commit `openapi.json` to repo

#### Event Endpoints

| Endpoint | Method | Contract | Implementation | Status |
|----------|--------|----------|----------------|--------|
| `/api/events` | POST | 201 Created, Event | Returns 201, Event ✓ | ✓ |
| `/api/events` | GET | 200 OK, Paginated | Returns Paginated ✓ | ✓ |
| `/api/events/batch` | POST | 201 Created, List | Returns 201, List ✓ | ✓ |
| `/api/events/upload` | POST | 200 OK, File | Returns 200, File info ✓ | ✓ |
| `/api/events/export` | GET | 200 OK, File | Returns CSV/JSON ✓ | ✓ |

**Issues:**
- Batch endpoint has rate limit (5/minute) - not documented
- Export endpoint has no pagination (limits to 1000 events) - not documented
- **Proposed:** Document rate limits and pagination in OpenAPI

#### Pattern Endpoints

| Endpoint | Method | Contract | Implementation | Status |
|----------|--------|----------|----------------|--------|
| `/api/patterns` | GET | 200 OK, Paginated | Returns Paginated ✓ | ✓ |
| `/api/patterns/export` | GET | 200 OK, File | Returns CSV/JSON ✓ | ✓ |

**Issues:**
- Export endpoint exports all patterns (no pagination) - could be large
- **Proposed:** Add pagination or streaming export

#### Suggestion Endpoints

| Endpoint | Method | Contract | Implementation | Status |
|----------|--------|----------|----------------|--------|
| `/api/suggestions` | GET | 200 OK, Paginated | Returns Paginated ✓ | ✓ |
| `/api/suggestions/generate` | POST | 200 OK, List | Returns List ✓ | ✓ |
| `/api/suggestions/{id}/bookmark` | POST | 200 OK | Returns 200 ✓ | ✓ |
| `/api/suggestions/{id}/apply` | POST | 200 OK | Returns 200 ✓ | ✓ |
| `/api/suggestions/{id}/dismiss` | POST | 200 OK | Returns 200 ✓ | ✓ |

**Issues:**
- `generate` endpoint creates placeholder suggestion - not real generation
- **Proposed:** Implement actual suggestion generation or document as placeholder

#### Workflow Endpoints

| Endpoint | Method | Contract | Implementation | Status |
|----------|--------|----------|----------------|--------|
| `/api/workflows` | POST | 201 Created, Workflow | Returns 201, Workflow ✓ | ✓ |
| `/api/workflows/{id}/rollback` | POST | 200 OK | Returns 200 ✓ | ✓ |
| `/api/workflows/{id}/execute` | POST | 200 OK, Execution | Returns Execution ✓ | ✓ |
| `/api/workflows/{id}/executions` | GET | 200 OK, List | Returns List ✓ | ✓ |

**Issues:**
- `execute` endpoint creates execution record but doesn't actually execute steps
- **Proposed:** Document as placeholder or implement execution

#### Organization Endpoints

| Endpoint | Method | Contract | Implementation | Status |
|----------|--------|----------|----------------|--------|
| `/api/organizations` | POST | 201 Created, Org | Returns 201, Org ✓ | ✓ |
| `/api/organizations` | GET | 200 OK, List | Returns List ✓ | ✓ |
| `/api/organizations/{id}/members` | GET | 200 OK, List | Returns List ✓ | ✓ |

**Issues:**
- No endpoint to update organization
- No endpoint to delete organization
- **Proposed:** Add missing endpoints or document as coming soon

#### Integration Endpoints

| Endpoint | Method | Contract | Implementation | Status |
|----------|--------|----------|----------------|--------|
| `/api/integrations/connectors` | GET | 200 OK, List | Returns List ✓ | ✓ |
| `/api/integrations` | POST | 201 Created, Integration | Returns 201, Integration ✓ | ✓ |

**Issues:**
- No endpoint to update integration
- No endpoint to delete integration
- No endpoint to test integration
- **Proposed:** Add missing endpoints

#### Health Check Endpoints

| Endpoint | Method | Contract | Implementation | Status |
|----------|--------|----------|----------------|--------|
| `/health` | GET | 200 OK | Returns 200 ✓ | ✓ |
| `/health/readiness` | GET | 200 OK or 503 | Returns 200/503 ✓ | ✓ |
| `/health/liveness` | GET | 200 OK | Returns 200 ✓ | ✓ |

**Issues:**
- Readiness check only checks database, not other dependencies (Redis, etc.)
- **Proposed:** Add Redis health check to readiness endpoint

### API Versioning

**Claimed:** API v1 with `/api/v1/*` prefix
**Reality:** All endpoints use `/api/*` prefix, not `/api/v1/*`
**File:** `backend/main.py:129` (router defined but unused)
**File:** `backend/api_v1.py` (empty stub)

**Drift:**
- `api_v1_router` defined but no routes added
- All routes defined directly on `app` with `/api/*` prefix
- **Proposed:** Either implement versioning or remove stub

### Authentication Contract

**Claimed:** JWT tokens with Bearer authentication
**Reality:** ✓ Implemented correctly
**File:** `backend/main.py:316-337` (get_current_user)

**Issues:**
- Token expiry (30 minutes) - not documented in OpenAPI
- Refresh token expiry (7 days) - not documented
- **Proposed:** Add authentication documentation to OpenAPI

### Rate Limiting Contract

**Claimed:** Rate limiting per endpoint
**Reality:** ✓ Implemented with `slowapi`
**File:** `backend/rate_limit.py`, `backend/main.py:161-163`

**Issues:**
- Rate limits not documented in OpenAPI
- Rate limit headers not returned in responses
- **Proposed:** Add rate limit headers (X-RateLimit-Limit, X-RateLimit-Remaining)

## Database Schema Contract Analysis

### Schema vs Models Comparison

| Model | Schema.sql | Models.py | Migration | Status |
|-------|------------|-----------|-----------|--------|
| users | ✓ | ✓ | - | ✓ |
| user_sessions | ✓ | ✓ | - | ✓ |
| events | ✓ | ✓ | - | ✓ |
| patterns | ✓ | ✓ | - | ✓ |
| relationships | ✓ | ✓ | - | ✓ |
| temporal_patterns | ✓ | ✓ | - | ✓ |
| suggestions | ✓ | ✓ | - | ✓ |
| user_configs | ✓ | ✓ | - | ✓ |
| workflows | ✓ | ✓ | - | ✓ |
| organizations | ✗ | ✓ | - | **DRIFT** |
| organization_members | ✗ | ✓ | - | **DRIFT** |
| audit_logs | ✗ | ✓ | - | **DRIFT** |
| workflow_versions | ✗ | ✓ | - | **DRIFT** |
| workflow_executions | ✗ | ✓ | - | **DRIFT** |
| integration_connectors | ✗ | ✓ | - | **DRIFT** |
| user_integrations | ✗ | ✓ | - | **DRIFT** |
| roles | ✗ | ✓ | - | **DRIFT** |
| feature_flags | ✗ | ✗ (separate file) | ✓ | **DRIFT** |
| experiments | ✗ | ✗ (separate file) | ✓ | **DRIFT** |
| fraud_scores | ✗ | ✗ (separate file) | ✓ | **DRIFT** |

**Issues:**
- `schema.sql` is incomplete (missing 10+ tables)
- `migrations/add_feature_flags_experiments_fraud.py` exists but models not in `database/models.py`
- **Proposed:** Generate schema.sql from models or archive it

### Schema Drift Detection

**Migration Status:**
- Alembic configured (`alembic.ini` exists)
- Migration file exists but may not be applied
- No migration status check on startup
- **Proposed:** Add migration status check

### ORM vs Migration Diffs

**Potential Issues:**
1. **Feature Flags/Experiments/Fraud Models**
   - Migration exists: `migrations/add_feature_flags_experiments_fraud.py`
   - Models in separate files: `backend/feature_flags.py`, etc.
   - Models not in `database/models.py`
   - **Risk:** Migration may fail or schema drift

2. **Organization Tables**
   - Models exist in `database/models.py`
   - No migration file for organizations
   - **Risk:** Tables may not exist in database

3. **Workflow Versioning**
   - Models exist: `WorkflowVersion`, `WorkflowExecution`
   - No migration file
   - **Risk:** Tables may not exist

### Unsafe Defaults

| Column | Table | Default | Issue | Fix |
|--------|-------|---------|-------|-----|
| `hashed_password` | users | None | Required but no default | Already nullable=False |
| `email_verified` | users | False | Users can't access until verified | Document requirement |
| `is_active` | users | True | New users active by default | Consider False for email verification |
| `subscription_tier` | organizations | "free" | Default tier | ✓ OK |
| `is_active` | workflows | True | New workflows active by default | ✓ OK |

### Nullable Surprises

| Column | Table | Nullable | Issue | Risk |
|--------|-------|----------|-------|------|
| `username` | users | True | Username optional | May cause confusion |
| `file_path` | events | True | Events can have no file | ✓ OK (command events) |
| `details` | events | True | Events can have no details | ✓ OK |
| `organization_id` | workflows | True | Workflows can be user-only | ✓ OK |

### N+1 Query Risks

**Potential N+1 Issues:**

1. **User Events Query**
   - `backend/main.py:955-989` (get_events)
   - Queries events, but no eager loading of user
   - **Risk:** Low (user already in context)

2. **Organization Members Query**
   - `backend/organizations.py:get_organization_members`
   - Queries members, but may need user details
   - **Risk:** Medium (if user details accessed)

3. **Workflow Executions Query**
   - `backend/workflow_scheduler.py:177-186`
   - Queries executions, but no eager loading
   - **Risk:** Low (executions don't have relations)

**Proposed Fixes:**
- Use `joinedload()` or `selectinload()` for relations
- Add query optimization for common patterns

### RLS Policy Risks

**Issue:** `schema.sql` has RLS policies for Supabase (`auth.uid()`)
**Reality:** Application uses JWT authentication, not Supabase auth
**Risk:** RLS policies won't work with current auth

**Proposed:**
- Remove RLS policies from schema.sql (not used)
- Or document as Supabase-specific
- Or implement Supabase auth integration

## Missing Endpoints

### Organization Management
- [ ] `PUT /api/organizations/{id}` - Update organization
- [ ] `DELETE /api/organizations/{id}` - Delete organization
- [ ] `POST /api/organizations/{id}/members` - Add member (exists but not documented)
- [ ] `PUT /api/organizations/{id}/members/{user_id}` - Update member role
- [ ] `DELETE /api/organizations/{id}/members/{user_id}` - Remove member

### Integration Management
- [ ] `GET /api/integrations` - List user integrations
- [ ] `GET /api/integrations/{id}` - Get integration details
- [ ] `PUT /api/integrations/{id}` - Update integration
- [ ] `DELETE /api/integrations/{id}` - Delete integration
- [ ] `POST /api/integrations/{id}/test` - Test integration connection

### Workflow Management
- [ ] `GET /api/workflows` - List workflows
- [ ] `GET /api/workflows/{id}` - Get workflow details
- [ ] `PUT /api/workflows/{id}` - Update workflow
- [ ] `DELETE /api/workflows/{id}` - Delete workflow
- [ ] `GET /api/workflows/{id}/versions` - List workflow versions

### User Management
- [ ] `GET /api/users` - List users (admin only)
- [ ] `GET /api/users/{id}` - Get user details (admin only)
- [ ] `PUT /api/users/{id}` - Update user (admin only)
- [ ] `DELETE /api/users/{id}` - Delete user (admin only)

## Contract Conformance Tests

**Current State:** No contract tests
**Proposed:**
- Add OpenAPI schema validation tests
- Add database schema validation tests
- Add endpoint response validation tests

**Files to create:**
- `tests/test_openapi_schema.py`
- `tests/test_database_schema.py`
- `tests/test_endpoint_responses.py`
