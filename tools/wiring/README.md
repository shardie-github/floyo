# Wiring Harness - Connectivity Verification System

## Overview

The Wiring Harness is a comprehensive end-to-end connectivity verification system for the Floyo monorepo. It tests all subsystems to ensure they are properly connected and functioning.

## Quick Start

```bash
# Install dependencies (from workspace root)
npm install

# Run the wiring harness
pnpm wiring:run

# Run the wire doctor (auto-fix suggestions)
pnpm wiring:doctor

# View connectivity report
pnpm wiring:report
```

## What It Checks

### Foundational
- ? Environment variables presence/usage
- ? Health endpoints (liveness, readiness)
- ? Database connectivity
- ? Redis connectivity (with fallback)

### AuthN/Z & RLS
- ? JWT authentication flow
- ? Protected endpoint authorization
- ?? RLS isolation (requires Supabase or application-level checks)

### Core Product Loop
- ? User registration
- ? Login flow
- ? Event creation/storage
- ? Pattern analysis
- ? Suggestions generation
- ? Stats endpoints

### Additional Subsystems
- ?? Payments (with stripe-mock fallback)
- ?? Partner network (redirect endpoints)
- ?? Growth/Experiments (module exists)
- ? Compliance (DSAR export)
- ? SRE (backup scripts)

## Output

The harness generates:

1. **JSON Report**: `reports/connectivity/connectivity.json`
   - Machine-readable connectivity matrix
   - Status, latency, evidence for each check

2. **Markdown Report**: `reports/connectivity/wiring_report.md`
   - Human-readable summary
   - Failures requiring attention
   - Recommendations

3. **Wire Doctor Fixes**: `tools/wiring/fixes/*.md`
   - Suggested fixes for detected issues
   - Code diffs and migration files

## Dashboard

View connectivity status at:
- **Admin Dashboard**: `/admin/wiring` (requires Next.js dev server)
- **API Endpoint**: `/api/wiring-status`

## CI Integration

The wiring check runs automatically in CI via `.github/workflows/wiring-check.yml`.

It:
- Spins up Postgres and Redis services
- Runs the wiring harness
- Runs E2E tests
- Fails if any critical checks fail

## E2E Tests

Additional E2E tests verify complete flows:

- **Web E2E**: `frontend/e2e/wiring.web.spec.ts`
  - Complete signup ? onboarding ? product usage
  - Payments flow (mock)
  - Partner redirects
  - DSAR export

- **Contract Tests**: `tools/testing/contracts/openapi.validate.spec.ts`
  - OpenAPI spec validation
  - Auth requirement verification
  - CORS headers

- **Jobs Tests**: `tools/testing/e2e/jobs.spec.ts`
  - Background job verification
  - DSAR export jobs

## Synthetic Fixtures

Pre-defined test data in `tools/testing/fixtures/synthetic.ts`:
- Users A & B (for RLS testing)
- Partner sandbox data
- Paywall variants
- Referral codes & coupons

## Troubleshooting

### Harness fails to connect to backend

1. Ensure backend is running: `cd backend && uvicorn main:app --reload`
2. Check `API_BASE_URL` environment variable
3. Verify health endpoint: `curl http://localhost:8000/health`

### Missing environment variables

The harness will mark optional variables as `DEGRADED` and use safe mocks:
- Supabase ? Mock auth
- Redis ? In-memory cache
- Stripe ? stripe-mock
- Analytics ? noop

### Path resolution errors

The harness uses `__dirname` to resolve workspace paths. If you get path errors:
- Ensure you're running from workspace root
- Check that `tools/wiring/harness.ts` exists

## Extending

To add new checks:

1. Add a new check method in `WiringHarness`:
```typescript
private async checkNewFeature(): Promise<void> {
  // Your check logic
  this.addResult({
    system: 'NewFeature',
    check: 'Feature Name',
    status: 'PASS' | 'FAIL' | 'DEGRADED' | 'SKIP',
    // ...
  });
}
```

2. Call it in `run()`:
```typescript
await this.checkNewFeature();
```

## Safety & Fallbacks

- **Never hardcode secrets** - Always use environment variables
- **Always provide fallbacks** - Use mocks when services unavailable
- **Never fake success** - Clearly mark degraded/mock modes
- **Document deltas** - Note what's mocked vs real in reports

## Exit Criteria

The harness succeeds (exit code 0) when:
- All critical checks (`FAIL` status) = 0
- At least one check has `PASS` or `DEGRADED` status

The harness fails (exit code 1) when:
- Any check has `FAIL` status
- Critical infrastructure is unavailable

---

*Generated by Floyo Wiring Harness*
